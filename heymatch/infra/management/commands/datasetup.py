import pathlib
import random

from django.conf import settings
from django.contrib.auth import get_user_model
from django.core import management
from django.core.management.base import BaseCommand
from django.db.utils import IntegrityError
from factory.django import ImageField
from phone_verify.models import SMSVerification
from tqdm import tqdm

from heymatch.apps.celery.tasks import aggregate_recent_24hr_top_ranked_group_address
from heymatch.apps.group.models import GroupMember, GroupProfilePhotoPurchased, GroupV2
from heymatch.apps.group.tests.factories import (
    GroupMemberFactory,
    GroupV2Factory,
    female_profile_image_filepath,
    male_profile_image_filepath,
)
from heymatch.apps.match.api.views import MatchRequestViewSet
from heymatch.apps.match.models import MatchRequest
from heymatch.apps.payment.models import PointItem
from heymatch.apps.user.models import AppInfo
from heymatch.apps.user.tests.factories import (
    ActiveCollegeFemaleUserFactory,
    ActiveCollegeMaleUserFactory,
    ActiveEmployeeFemaleUserFactory,
    ActiveEmployeeMaleUserFactory,
    ActiveEtcFemaleUserFactory,
    ActiveEtcMaleUserFactory,
    ActivePractitionerFemaleUserFactory,
    ActivePractitionerMaleUserFactory,
    UserProfileImageFactory,
)

User = get_user_model()
# stream = settings.STREAM_CLIENT


"""
Note that Custom Commands are only available in LOCAL environment.
See config/settings/local.py
"""


def generate_user():
    factory = random.choice(
        [
            ActiveEmployeeMaleUserFactory,
            ActiveCollegeMaleUserFactory,
            ActiveEtcMaleUserFactory,
            ActivePractitionerMaleUserFactory,
            ActiveEtcFemaleUserFactory,
            ActiveEmployeeFemaleUserFactory,
            ActiveCollegeFemaleUserFactory,
            ActivePractitionerFemaleUserFactory,
        ]
    )
    return factory.create()


def generate_user_batch(size: int):
    factory = random.choice(
        [
            ActiveEmployeeMaleUserFactory,
            ActiveCollegeMaleUserFactory,
            ActiveEtcMaleUserFactory,
            ActivePractitionerMaleUserFactory,
            ActiveEtcFemaleUserFactory,
            ActiveEmployeeFemaleUserFactory,
            ActiveCollegeFemaleUserFactory,
            ActivePractitionerFemaleUserFactory,
        ]
    )
    return factory.create_batch(size=size)


class Command(BaseCommand):
    help = "Command for initial data setup in devel environment"

    def add_arguments(self, parser):
        parser.add_argument(
            "--reset_db",
            action="store_true",
            help="Rest DB before datasetup",
        )
        parser.add_argument(
            "--noinput",
            action="store_true",
            help="Bypass input from command",
        )
        parser.add_argument(
            "--migrate_all",
            action="store_true",
            help="Migrate all steps",
        )

    def handle(self, *args, **options):
        """Rest DB and migrate"""

        migrate_all = False
        if options["migrate_all"]:
            self.stdout.write(
                self.style.WARNING(
                    "You selected `migrate all`. Will migrate all steps."
                )
            )
            migrate_all = True

        if options["reset_db"]:
            if options["noinput"]:
                management.call_command("reset_db", "--noinput")
            else:
                management.call_command("reset_db")

        # it is user's responsibility
        management.call_command("migrate", "--noinput")

        # -------------- Superuser setup -------------- #
        if migrate_all or input("Create Superuser? [y/N]") == "y":
            self.generate_superuser()

        # -------------- Developer Users setup -------------- #
        if migrate_all or input("Create Developer User? [y/N]") == "y":
            self.generate_developer_users()

        # -------------- Normal Users setup -------------- #
        if migrate_all or input("Create Normal User? [y/N]") == "y":
            self.generate_normal_users()

        # -------------- Hotplace, Group, Users setup -------------- #
        if migrate_all or input("Create Groups? [y/N]") == "y":
            self.generate_groups()

        # -------------- Payment setup -------------- #
        if migrate_all or input("Create Payments? [y/N]") == "y":
            self.generate_payment_items()

        # -------------- Recent24HrTopGroupAddress setup -------------- #
        if migrate_all or input("Create Recent24HrTopGroupAddress? [y/N]") == "y":
            self.generate_24hr_top_group_address()

        # -------------- AppInfo setup -------------- #
        if migrate_all or input("Create App info? [y/N]") == "y":
            self.generate_app_info_item()

        # -------------- Done! -------------- #
        self.stdout.write(self.style.SUCCESS("Successfully set up all mocking data!"))

    def generate_superuser(self) -> None:
        self.stdout.write(self.style.SUCCESS("Setting up data for [Superuser]"))
        try:
            User.objects.create_superuser(  # superuser
                username=settings.DJANGO_ADMIN_ID,
                phone_number="+821000000000",
                password=settings.DJANGO_ADMIN_PASSWORD,
            )
            # Register Stream token
            # stream.upsert_user({"id": str(u.id), "role": "user"})
        except IntegrityError:
            # u = User.objects.get(username="admin")
            # stream.upsert_user({"id": str(u.id), "role": "user"})
            self.stdout.write(
                self.style.NOTICE("Integrity Error @ {}".format("create_superuser"))
            )
            pass
        SMSVerification.objects.get_or_create(  # sms for user 1
            phone_number="+821000000000",
            defaults={
                "security_code": "098765",
                "session_token": "sessiontoken2",
                "is_verified": True,
            },
        )

    def generate_developer_users(self) -> None:
        self.stdout.write(self.style.SUCCESS("Setting up data for [Developer]"))
        users = [
            # ActiveEmployeeMaleUserFactory.create(phone_number="+821043509595"),
            ActiveEmployeeMaleUserFactory.create(phone_number="+821032433994"),
        ]
        dev_groups = []
        for user in users:
            if user.gender == "m":
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(male_profile_image_filepath)}"
                    ),
                )
            else:
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(female_profile_image_filepath)}"
                    ),
                )
            # create group
            group = GroupV2Factory.create(mode=GroupV2.GroupMode.SIMPLE)
            dev_groups.append((group, str(user.id)))
            GroupMemberFactory.create(group=group, user=user, is_user_leader=True)

        # generate MatchRequests
        sender_groups = GroupV2Factory.create_batch(
            size=3, mode=GroupV2.GroupMode.SIMPLE
        )
        for group in sender_groups:
            user = generate_user()
            if user.gender == "m":
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(male_profile_image_filepath)}"
                    ),
                )
            else:
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(female_profile_image_filepath)}"
                    ),
                )
            GroupMemberFactory.create(group=group, user=user, is_user_leader=True)
        receiver_groups = GroupV2Factory.create_batch(
            size=3, mode=GroupV2.GroupMode.SIMPLE
        )
        for group in receiver_groups:
            user = generate_user()
            if user.gender == "m":
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(male_profile_image_filepath)}"
                    ),
                )
            else:
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(female_profile_image_filepath)}"
                    ),
                )
            GroupMemberFactory.create(group=group, user=user, is_user_leader=True)

        for group_info in dev_groups:
            # MR1
            MatchRequest.objects.create(
                sender_group=sender_groups[0],
                receiver_group=group_info[0],
                status=MatchRequest.MatchRequestStatusChoices.WAITING,
            )
            gm = GroupMember.objects.filter(group=sender_groups[0]).first()
            GroupProfilePhotoPurchased.objects.create(
                buyer=gm.user, seller=group_info[0]
            )

            # MR2
            mr = MatchRequest.objects.create(
                sender_group=sender_groups[1],
                receiver_group=group_info[0],
                status=MatchRequest.MatchRequestStatusChoices.ACCEPTED,
            )
            gm = GroupMember.objects.filter(group=sender_groups[1]).first()
            GroupProfilePhotoPurchased.objects.create(
                buyer=gm.user, seller=group_info[0]
            )
            # accepted MRs should open getstream chat
            MatchRequestViewSet.create_stream_channel(
                group_info[1], mr, send_push_notification=False
            )

            # MR3
            MatchRequest.objects.create(
                sender_group=sender_groups[2],
                receiver_group=group_info[0],
                status=MatchRequest.MatchRequestStatusChoices.REJECTED,
            )
            gm = GroupMember.objects.filter(group=sender_groups[2]).first()
            GroupProfilePhotoPurchased.objects.create(
                buyer=gm.user, seller=group_info[0]
            )

            # MR4
            MatchRequest.objects.create(
                sender_group=group_info[0],
                receiver_group=receiver_groups[0],
                status=MatchRequest.MatchRequestStatusChoices.WAITING,
            )
            GroupProfilePhotoPurchased.objects.create(
                buyer_id=group_info[1], seller=receiver_groups[0]
            )

            # MR5
            mr = MatchRequest.objects.create(
                sender_group=group_info[0],
                receiver_group=receiver_groups[1],
                status=MatchRequest.MatchRequestStatusChoices.ACCEPTED,
            )
            GroupProfilePhotoPurchased.objects.create(
                buyer_id=group_info[1], seller=receiver_groups[1]
            )
            # accepted MRs should open getstream chat
            MatchRequestViewSet.create_stream_channel(
                group_info[1], mr, send_push_notification=False
            )

            # MR6
            MatchRequest.objects.create(
                sender_group=group_info[0],
                receiver_group=receiver_groups[2],
                status=MatchRequest.MatchRequestStatusChoices.REJECTED,
            )
            GroupProfilePhotoPurchased.objects.create(
                buyer_id=group_info[1], seller=receiver_groups[2]
            )

    def generate_normal_users(self) -> None:
        self.stdout.write(self.style.SUCCESS("Setting up data for [Users]"))
        users = generate_user_batch(size=2)
        for user in users:
            if user.gender == "m":
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(male_profile_image_filepath)}"
                    ),
                )
            else:
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(female_profile_image_filepath)}"
                    ),
                )

    def generate_groups(self) -> None:
        # Invite Groups
        self.stdout.write(self.style.SUCCESS("Setting up data for [Groups.INVITE]"))
        SIZE = 100 if not settings.DEBUG else 10
        # pbar = tqdm(total=SIZE)
        # groups = GroupV2Factory.create_batch(size=SIZE, mode=GroupV2.GroupMode.INVITE)
        # for group in groups:
        #     users = ActiveUserFactory.create_batch(size=random.choice([2, 3, 4]))
        #     for idx, user in enumerate(users):
        #         UserProfileImageFactory.create(
        #             user=user,
        #             image=ImageField(
        #                 from_path=f"{pathlib.Path().resolve()}/heymatch/data/{random.choice(profile_image_filepath)}"
        #             ),
        #         )
        #         is_leader = False
        #         if idx == 0:
        #             is_leader = True
        #         GroupMemberFactory.create(
        #             group=group, user=user, is_user_leader=is_leader
        #         )
        #     pbar.update(1)
        # pbar.close()
        # Simple Groups
        self.stdout.write(self.style.SUCCESS("Setting up data for [Groups.SIMPLE]"))
        pbar = tqdm(total=SIZE)
        groups = GroupV2Factory.create_batch(size=SIZE, mode=GroupV2.GroupMode.SIMPLE)
        for group in groups:
            user = generate_user()
            if user.gender == "m":
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(male_profile_image_filepath)}"
                    ),
                )
            else:
                UserProfileImageFactory.create(
                    user=user,
                    image=ImageField(
                        from_path=f"{pathlib.Path().resolve()}/heymatch/data/profile/"
                        f"{random.choice(female_profile_image_filepath)}"
                    ),
                )
            GroupMemberFactory.create(group=group, user=user, is_user_leader=True)
            pbar.update(1)
        pbar.close()

    def generate_payment_items(self) -> None:
        self.stdout.write(self.style.SUCCESS("Setting up data for [Payments]"))
        # Point Items
        PointItem.objects.create(
            name="캔디 5개",
            product_id="com.co188.heymatch.point_item1",
            price_in_krw=4400,
            default_point=5,
        )
        PointItem.objects.create(
            name="캔디 10개+1개",
            product_id="com.co188.heymatch.point_item2",
            price_in_krw=9900,
            default_point=10,
            bonus_point=2,
        )
        PointItem.objects.create(
            name="캔디 15개+5개",
            product_id="com.co188.heymatch.point_item3",
            price_in_krw=14000,
            default_point=15,
            bonus_point=5,
            best_deal_check=True,
        )
        PointItem.objects.create(
            name="캔디 30개+15개",
            product_id="com.co188.heymatch.point_item4",
            price_in_krw=22000,
            default_point=25,
            bonus_point=15,
        )
        PointItem.objects.create(
            name="캔디 50개+35개",
            product_id="com.co188.heymatch.point_item5",
            price_in_krw=39000,
            default_point=50,
            bonus_point=30,
        )
        # Freepass Items
        # FreePassItem.objects.create(
        #     name="원데이 프리패스 (24h)",
        #     product_id="com.co188.heymatch.free_pass_item1",
        #     price_in_krw=12000,
        #     free_pass_duration_in_hour=24,
        #     best_deal_check=True,
        # )

    def generate_24hr_top_group_address(self) -> None:
        self.stdout.write(
            self.style.SUCCESS("Setting up data for [Recent24HrTopGroupAddress]")
        )
        aggregate_recent_24hr_top_ranked_group_address()

    def generate_app_info_item(self) -> None:
        self.stdout.write(self.style.SUCCESS("Setting up data for [AppInfo]"))
        faq = "https://docs.google.com/forms/d/e/1FAIpQLScJwGBy92H9EoZagufzgBXGSwtN1dOxQbfctVnNPa1kOocACA/viewform"
        AppInfo.objects.create(
            faq_url=faq,
            terms_of_service_url="https://www.hey-match.com/agreement",
            privacy_policy_url="https://www.hey-match.com/privacy-terms",
            terms_of_location_service_url="https://www.hey-match.com/location-terms",
            business_registration_url="https://www.hey-match.com/corporate",
        )

    # DEPRECATED
    # def generate_hotplace_groups(self) -> None:
    #     for name in RANDOM_HOTPLACE_NAMES:
    #         # create hotplace
    #         hotplace = HotPlaceFactory(
    #             name=name,
    #             zone_center_geoinfo=RANDOM_HOTPLACE_INFO[name]["zone_center_geoinfo"],
    #             zone_boundary_geoinfos=RANDOM_HOTPLACE_INFO[name][
    #                 "zone_boundary_geoinfos"
    #             ],
    #             zone_boundary_geoinfos_for_fake_chat=RANDOM_HOTPLACE_INFO[name][
    #                 "zone_boundary_geoinfos_for_fake_chat"
    #             ],
    #         )
    #         # create groups for each hotplaces
    #         for image_path in profile_image_filepath:
    #             geopt = generate_rand_geoopt_within_boundary(
    #                 RANDOM_HOTPLACE_INFO[name]["zone_boundary_geoinfos"]
    #             )
    #             group = ActiveGroupFactory.create(
    #                 hotplace=hotplace,
    #                 gps_geoinfo=geopt,
    #             )
    #             # Create group profile image
    #             GroupProfileImageFactory.create(
    #                 group=group,
    #                 image=ImageField(
    #                     from_path=f"{pathlib.Path().resolve()}/heymatch/data/{image_path}"
    #                 ),
    #             )
    #             # Create users for each groups
    #             # NOTE: For now, only one user is mapped to one group so size is 1
    #             ActiveUserFactory.create_batch(
    #                 size=1,
    #                 joined_group=group,
    #             )
    #             # Group.objects.register_group_leader_user(group, users[0])
    #             # Group.objects.register_normal_users(group, users[1:])
    #
    #     self.stdout.write(
    #         self.style.SUCCESS("Successfully set up data for [Hotplaces/Groups/User]")
    #     )
